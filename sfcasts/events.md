# Events

One more way to add some custom behavior to our code instead of overriding parent methods in our controllers is events. Check this out. Over on our Question section... so `QuestionCrudController.php`, up in `configureField`... let's return one more field. Say `yield AssociationField::new('updatedBy')`. This is a field on my question entity, which is a many-to-one to User. The idea is that, whenever someone updates a question, this field will be set to the user that just updated it. I'm going to make this *only* show up on the detail page: `->onlyOnDetail()`.

Right now, in my fixtures, I didn't set that field. So if I go to any question, you're going to see "Updated By" "Null". Our goal is to set that field automatically when a question is updated. A great solution for this is to use the doctrine extensions library, and it's "blameable". This is a way to update a field to the last user that modified it across your *entire* application. Let's see if we can achieve this *just* for inside our EasyAdmin section via events. EasyAdmin has a bunch of events that it dispatches and the best way to find them is to go into the source code and open the `/Event` directory. Most of these are pretty self explanatory. Before any CRUD action is executed, "after" would be at the end of it. We also have a bunch of things related to entities here, like `BeforeEntityUpdatedEvent.php` or `BeforeEntityPersistedEvent.php`, where "persisted" means "created".

In our case, the one I'm looking at is `BeforeEntityUpdatedEvent.php`. If we could run code *before* an entity is updated, we can set this `updatedBy` field and then it will save naturally. So let's do that. I'll open up that `BeforeEntityUpdatedEvent.php` field, copy its namespace, and then, over on our terminal, generate the entity:

```terminal
symfony console make:subscriber
```

And let's call it:

```terminal
BlameableSubscriber
```

It's going to ask us which event we want to listen to, aqnd it will suggest a bunch of them, just from the core of Symfony. The one from EasyAdmin Bundle won't be there, so I'll paste its namespace, *then* go grab its class name. There we go. And... perfect! We have a new `BlameableSubscriber` class. Go open that up: `/src/EventSubscriber/BlameableSubscriber.php`. This is a normal Symfony event subscriber, thanks to auto configuration. It's instantly going to see this class and it's already set up so that whenever EasyAdmin dispatches `BeforeEntityUpdatedEvent.php`, it will call our method right here.

This `$event` object is *packed* with information that's useful for us. For example, if I just say `$event->`, you can see it has *one* method on it called `getEntityInstance()`, which is *exactly* what we want. To be able to set the `updatedBy` property on our question, we're going to need the current user object. We get that via the security service. So let's autowire that - `__construct()` - with a `Security $security` argument. Then hit "alt" + "enter" and go "Initialize properties" to create that property and set it. Beautiful!

Let's start with `$question = $event->getEntityInstance`. And just as a little sanity check here (and to help our editor), I'll say `if (!$question instanceof Question)` and then I'll `return` because this is going to be called when *any* entity is saved across our entire system. Next, say `$user = $this->security->getUser()` and `if (!$user instanceof User)`. Then throw an exception: `throw new LogicException()`. The exception class doesn't matter, so we'll just add a little message here.

This is a situation that will *never* actually happen. We only have one user class in our app, so if you're logged in, you're *definitely* this `User` instance. *But*, this helps our editor and static analysis tools know confidently that this `User` object is going to be *our* `User` object. Down here... we can now say `$question->setUpdatedBy()`, and then `$user`. My editor's going to be happy knowing that this user is my user entity. All right, let's try it. I have one here and my "Updated By" is "Null". Edit something (make sure you actually make a change so it saves), I'll hit "Save changes" and... got it! "Updated By" is populated! And *that* is my current user. Sweet!

So events are a super powerful concept in EasyAdmin. However, they're a little bit less important in EasyAdmin Bundle 3 and 4 than they used to be. And that's because most of our configuration is now written in PHP in our controller. So instead of leveraging events, there's an easier way. We can just override a method in our controller. Event subscribers *still* have their place, because this is a great way to do an operation on multiple entities in your system. But if you only need to do something on *one* entity, it's easier just to override a method inside that entity's controller.

It doesn't matter where, but I'll go to the bottom. We're going to override yet *another* method. The methods that we can override are almost a ReadMe in all the different ways you can modify things. There's a `createEntity` method, a `createEditForm` method, and the one we want is called `updateEntity`. This is a method that actually updates and saves the entity. Before we update the entity, we want to set the property. Go steal this code from our subscriber... close that event class... paste that in... and hit "OK" to add that use statement. And now we'll tweak some code: Just `$user = $this->getUser()`. And then `$question` is actually going to be `$entityInstance`, so we can say `$entityInstance->setUpdatedBy()`. Okay, I'm kind of skipping ahead here, but if you wanted to code defensively, since there's no type on `$entityInstance` here, we could actually do another check like this and say `if (!$entityInstance instanceof Question)` and you could throw an exception. But in practice, it will always have a type, so we can call the `setUpdatedBy()` method on it. All right, let's see if this works. Go into `BlameableSubscriber.php` and comment out the listener. The subscriber's still here, but it's not going to *do* anything anymore. Then go back to Questions... edit a different question... Actually, before I edit it, let's go look at the details to make sure there's no "Updated By". Perfect! Now edit, make a change, save your changes, and... beautiful! That works!

Next, let's do a little bit more with our admin menu over here, like adding sections so we can organize this better.
